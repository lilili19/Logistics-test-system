var ap = null;
var isLoadHttp = 0;

function getXmlCode() {
    var configFile = $("#txtConfigFile").val();
    if (configFile == "") { alert("config文件不能为空"); return }
    var data = "configFile=" + configFile;
    ap.success = getXmlCodeEnd;
    ap.go("doGetXmlCode", data, "text");
}

function getXmlCodeEnd(resData) {
    //APL.dlg = function (title, url, w, h, btnFun, btnName, dlgType)
    if (resData == undefined || resData==null || resData=="") {
        alert("读取XML文件失败");
        return;
    }
    if (resData.length < 20) {
        alert(resData);
        return;
    }

    var strHtml = "<div style=\"padding: 3px 10px;margin-left:15px;margin-top:1px\">";
    strHtml += "<div class='row' style=\"margin-bottom:5px\"><button class='btn btn-success' type='button'  onclick=\"saveXmlCode()\">保存</button><button class='btn btn-success' type='button' style='margin-left:30px'  onclick=\"APL.closeDlg(0)\">关闭</button></div>";
    strHtml += "<div class='row'><textarea style='width:1050px;height:450px;overflow-x:scroll;' id='txtXmlCode'>" + resData + "</textarea></div></div>";
    //alert(strHtml);
    APL.dlg("编辑XML源文件", strHtml, 1100, 550, "", "", 1, ['5px', '10px']);
}

function saveXmlCode() {
    var configFile = $("#txtConfigFile").val();
    if (configFile == "") { alert("config文件不能为空"); return }
    var xmlCode = $("#txtXmlCode").val();
    if (xmlCode == "") {
        alert("XML内容不能为空");
        return;
    }
    var data = "configFile=" + configFile + "&xmlCode=" + APL.escape(xmlCode);
    //alert(data);
    ap.go("doSaveXmlCode", data, "json");
}

function downHttpFile2() {
    isLoadHttp = 1;
    doGetModeld();
}

function loadLocalFile2() {
    isLoadHttp = 0;
    doGetModeld();
}

function doGetModeld() {
    var appPath = $("#txtAppPath").val();
    var httpFile = "";
    if (isLoadHttp == 1) httpFile = $("#txtHttpFile").val();
    var configFile = $("#txtConfigFile").val();
    if (httpFile=="" && configFile == "") { alert("config文件不能为空"); return }
    configFile = configFile;
    var m = document.getElementById("txtModelName").value;
    var data = "appPath=" + appPath + "&configFile=" + configFile + "&httpFile=" + $("#txtHttpFile").val() + "&Model=" + m;
    ap.success = GetModeldEnd;
    ap.go("doGetModeld", data, "json");
}

function GetModeldEnd(resData) {
    if (resData.Error != undefined) { alert(resData.Error); return; }
    if (resData == undefined) {
        alert("返回undefined");
        return;
    }
    if (resData.modelName != undefined) $("#txtModelName").val(resData.modelName);
    if (resData.modelSpace != undefined) $("#txtModelSpace").val(resData.modelSpace);
    if (resData.sqlList != undefined) $("#txtListSQL").val(resData.sqlList);
    if (resData.sqlInfo != undefined) $("#txtInfoSQL").val(resData.sqlInfo);
    if (resData.sqlExport != undefined) $("#txtExportSQL").val(resData.sqlExport);
    if (resData.exportHear != undefined) $("#txtExportHear").val(resData.exportHear);
    if (resData.configFile != undefined && resData.configFile != "") $("#txtConfigFile").val(resData.configFile);
   
    if (resData.rows==undefined) {
        alert("返回resData.rows=undefined");
        return;
    }
    var mHtml = "";
    var data = resData.rows;
    var dbTab0 = "", dbTab = "", fieldName = "", textVal = "", dbName = "", title = "", val = "", dataType = "", minVal = "", maxVal = "", accNull = "";
    for (var i in data) {
        dbTab = data[i]["dbTab"];
        fieldName = data[i]["name"];
        dbName = data[i]["dbName"];
        if (dbName == "") dbName = fieldName;
        title = data[i]["title"];
        dataType = data[i]["type"];
        minVal = data[i]["min"];
        maxVal = data[i]["max"];
        accNull = data[i]["accNull"];
        
        textVal = fieldName + " " + title
        val = dbTab + "," + fieldName + "," + dbName + "," + title + "," + dataType + "," + minVal + "," + maxVal + "," + accNull;
        if (dbTab0 != dbTab) {
            if (mHtml != "") mHtml += "<br>";
            mHtml += dbTab + ' <input type="button" value="创建DB表" onclick="doCreateDB(\'' + dbTab + '\')"  style="width:80px;margin-left:10px" /> <br>';
        }
        mHtml += '<input style="margin-left:15px" type="checkbox" name="chkM" value="' + val + '"> ' + textVal + "<br>";

        dbTab0 = dbTab;
    }
    
    $("#divModel").html(mHtml);
    if (resData.Message != undefined && resData.Message != "") alert(resData.Message);
}

function doCreateDB(dbTab) {
    if (confirm("确认要创建或修改DB." + dbTab + "表吗？") == false) return;
    if (dbTab == "") { alert("dbTab不能为空"); return }
    var configFile = $("#txtConfigFile").val();
    if (configFile == "") { alert("config文件不能为空"); return }
  
    var arr = null;
    var dbName = "",  fields = "", rowVal = "";
    $("input:checked[name=chkM]").each(function () {
        rowVal = $(this).val();
        arr = rowVal.split(',');
        if (fields != "") fields += ",";
        fields += arr[0] + "." + arr[2];
    })

    var data = "dbTab=" + dbTab + "&configFile=" + configFile;
    //alert(data);
    ap.go("doCreateDB", data, "json");
}

function doCreateSQL(sqlName) {
    var dbTab = "", dbTab0 = "", dbTabFirst = "", exportHear = "",title="", fieldName = "", fieldTab = "", dbName = "", rowVal = "";
    var sql = "", sqlTab = "";
    var arr = null;

    $("input:checked[name=chkM]").each(function () {
        rowVal = $(this).val();
        //alert(rowVal);
        arr = rowVal.split(',');
        dbTab = arr[0];
        if (dbTabFirst == "") dbTabFirst = dbTab;

        fieldName = arr[1];
        dbName = arr[2];
        if (dbName == "") dbName = fieldName;
        //alert(dbName);
        if (dbName != "CompanyID") {
            if (sql != "") sql += ",";
            if (dbTab != dbTab0 && dbTab0 != "") fieldTab = dbTab;
            if (fieldTab != "") sql += "[" + fieldTab + "].";
            sql += "[" + dbName + "]";
            if (dbName != fieldName) sql += " AS " + fieldName;

            if (dbTab != dbTab0) {
                if (sqlTab != "") sqlTab += " INNER JOIN ";
                sqlTab += " [" + dbTab + "]";
            }

            if (sqlName == "Export" && fieldName!="id") {
                if (exportHear != "") exportHear += "|";
                exportHear += fieldName + "," + arr[3] + ",100";
            }

            dbTab0 = dbTab;
        }
    });

    sql = "SELECT " + sql + " FROM " + sqlTab;
    if (sqlName == "Export") {
        $("#txtExportSQL").val(sql);
        $("#txtExportHear").val(exportHear);
    }
    else {
        $("#txtSqlBLLName").val(dbTabFirst);
        $("#txtSqlBLL").val(sql);
    }
}

function doCreateGrid() {
    var dbTab = "", dbTab0 = "", fieldTab = "", fieldName = "", dbName = "", title = "", rowVal = "";
    var sql = "", sqlTab = "", colModel = "";
    var arr = null;
    var modelName = "";
    //alert(modelName);

    $("input:checked[name=chkM]").each(function () {
        rowVal = $(this).val();
        //alert(rowVal);
        arr = rowVal.split(',');
        dbTab = arr[0];
        if (modelName == "") modelName = dbTab;
        
        fieldName = arr[1];
        dbName = arr[2];
        if (dbName == "") dbName = fieldName;
        //alert(dbName);
        if (dbName != "CompanyID") {
            title = arr[3];
            

            if (sql != "") sql += ",";
            if (dbTab != dbTab0 && dbTab0 != "") fieldTab = dbTab;
            if (fieldTab != "") sql += "[" + fieldTab + "].";
            sql += "[" + dbName + "]";
            if (dbName != fieldName) sql += " AS " + fieldName;

            if (dbTab != dbTab0) {
                if (sqlTab != "") sqlTab += " INNER JOIN ";
                sqlTab += " [" + dbTab + "]";
            }
            dbTab0 = dbTab;

            if (fieldName == "id")
                colModel += '{ name: "id", width: 50, align: "center", formatter: customCell, dlg: "' + modelName + '/Edit?id=[name]", text: "详细", dlgWidth: 800, dlgHeight: 520 }\n';
            else
                colModel += "{ name: '" + fieldName + "', title:'" + title + "', width: 50, editable: true }\n";
        }
    });

    sql = "SELECT " + sql + " FROM " + sqlTab;
    $("#txtListSQL").val(sql);
    $("#txtGrid").val(colModel);
}

function doCreateInfo() {
    var dbTab = "", dbTab0 = "", fieldTab = "", fieldName = "", dbName = "", title = "", rowVal = "";
    var dataType = "", minVal = "", maxVal = "", accNull = "", errormsg = "", nullmsg = "";
    var sql = "", sqlTab = "", infoVals = "";
    var arr = null;
    var isEdit = $("#chkEdit").is(':checked');
    var isInfo = $("#chkInfo").is(':checked');
    //return;

    $("input:checked[name=chkM]").each(function () {
        rowVal = $(this).val();
        //alert(rowVal);
        //val = tabName + "," + fieldName + "," + dbName + "," + title + "," + dataType + "," + minVal + "," + maxVal + "," + accNull;
        arr = rowVal.split(',');
        dbTab = arr[0];
        fieldName = arr[1];
        dbName = arr[2];
        if (dbName == "") dbName = fieldName;

        if (fieldName != "CompanyID") {
            title = arr[3];

            dataType = "";
            if (arr.length > 4) dataType = arr[4];

            minVal = 0;
            if (arr.length > 5) minVal = arr[5];

            maxVal = 0;
            if (arr.length > 6) maxVal = arr[6];

            accNull = 0;
            if (arr.length > 7) accNull = arr[6];

            if (sql != "") sql += ",";
            if (dbTab != dbTab0 && dbTab0 != "") fieldTab = dbTab;
            if (fieldTab != "") sql += "[" + fieldTab + "].";
            sql += "[" + dbName + "]";
            if (dbName != fieldName) sql += " AS " + fieldName;

            if (dbTab != dbTab0) {
                if (sqlTab != "") sqlTab += " INNER JOIN ";
                sqlTab += " [" + dbTab + "]";
            }
            dbTab0 = dbTab;

            //datatype="s2-16" errormsg="国家为2-16个字符！" nullmsg
            errormsg = ""; nullmsg = "";
            if (dataType == "string") {
                if (minVal > 0 || maxVal > 0) {
                    dataType = "*" + minVal + "-" + maxVal;
                    errormsg = title + "必须为" + minVal + "-" + maxVal + "个字符";
                }
                else {
                    dataType = "";
                }
            }
            else if (dataType == "date") {
                dataType = "*";
                errormsg = title + "必须为日期";
            }
            else if (dataType == "int") {
                dataType = "n";
                errormsg = title + "必须为整数";
            }
            else if (dataType == "decimal" || dataType == "double") {
                dataType = "/^-?[1-9]＋(\\.\\d＋)?$|^-?0(\\.\\d＋)?$|^-?[1-9]＋[0-9]*(\\.\\d＋)?$/";
                errormsg = title + "必须为数值";
            }
            else {
                dataType = "";
            }
            if (accNull == 0 || accNull == "0") nullmsg = title + "不能为空";
            if (nullmsg != "" && dataType == "") dataType = "*";
            if (fieldName != "id" && fieldName != "ID") {
                if (isEdit == false && isInfo == true) {
                    infoVals += "type=\"div\" dataName=\"" + fieldName + "\" title=\"" + title + "\"";
                }
                else {
                    infoVals += "type=\"text\" dataName=\"" + fieldName + "\" title=\"" + title + "\"";
                    if (dataType != "") {
                        infoVals += " datatype=\"" + dataType + "\" errormsg=\"" + errormsg + "\"";
                        if (nullmsg != "") infoVals += " nullmsg=\"" + nullmsg + "\"";
                    }
                }
                infoVals += "\n";
            }
        }
    });

    sql = "SELECT " + sql + " FROM " + sqlTab;
    $("#txtInfoSQL").val(sql);
    $("#txtInfo").val(infoVals);
}

function doSaveSQL() {
    var configFile = $("#txtConfigFile").val();
    if (configFile == "") { alert("config文件不能为空"); return }
    var sqlList = $("#txtListSQL").val();
    var sqlInfo = $("#txtInfoSQL").val();
    var sqlExport = $("#txtExportSQL").val();
    var exportHear = $("#txtExportHear").val();
    var sqlBLLName = $("#txtSqlBLLName").val();
    var sqlBLL = $("#txtSqlBLL").val();
    
    var data = "configFile=" + configFile + "&sqlList=" + sqlList + "&sqlInfo=" + sqlInfo + "&sqlExport=" + sqlExport + "&exportHear=" + exportHear + "&sqlBLLName=" + sqlBLLName + "&sqlBLL=" + sqlBLL;
    ap.go("doSaveSQL", data, "json");
}

function doCreateFile(fileType) {
    if (fileType == "") {
        if (confirm('确认要生成所选文件吗？') == false) return;
    }
    var appPath = $("#txtAppPath").val();
    //if (path == "") { alert("config路径不能为空"); return }
    var configFile = $("#txtConfigFile").val();
    //if (configFile == "") { alert("config文件不能为空"); return }

    var ModelName = $("#txtModelName").val(); if (ModelName == "") { alert("模块名称不能为空"); return false; }//命名空间
    var ModelTemp = "", BLLTemp = "", BLLTemp = "", ControllerTemp = "",ListViewTemp = "", EditViewTemp = "", InfoViewTemp = "";
    var ListViewSave = "", EditViewSave = "", InfoViewSave = "", Grid="",Info="";

    if (fileType == "Model" || (fileType == "" && $("#chkModel").is(':checked'))) {
        ModelTemp = $("#txtModelTemp").val();
        if (fileType == "Model" && ModelTemp == "") { alert("Model模板不能为空"); return false; }
    }
    if (fileType == "BLL" || (fileType == "" && $("#chkBLL").is(':checked'))) {
        BLLTemp = $("#txtBLLTemp").val();
        if (fileType == "BLL" && BLLTemp == "") { alert("BLL模板不能为空"); return false; }
    }
    if (fileType == "Controller" || fileType == "") {
        ControllerTemp = $("#txtControllerTemp").val();
        if (fileType == "Controller" && ControllerTemp == "") { alert("Controller模板不能为空"); return false; }
    }

    //alert("Grid="+Grid);
    if (fileType == "ListView" || (fileType == "" && $("#chkListView").is(':checked'))) {
        Grid = $("#txtGrid").val();
        if (fileType == "ListView" && Grid == "") { alert("Grid参数不能为空"); return false; }
        ListViewTemp = $("#txtListViewTemp").val(); if (fileType == "ListView" && ListViewTemp == "") { alert("列表视图模板不能为空"); return false; }
        ListViewSave = $("#txtListViewSave").val(); if (fileType == "ListView" && ListViewSave == "") { alert("列表视图保存文件名不能为空"); return false; }
    }
    if (fileType == "InfoView" || (fileType == "" && $("#chkInfoView").is(':checked'))) {
        Info = $("#txtInfo").val();
        if (Info == "") { alert("数据项不能为空"); return false; }
        InfoViewTemp = $("#txtInfoViewTemp").val(); if (fileType == "InfoView" && InfoViewTemp == "") { alert("详细视图模板不能为空1"); return false; }
        InfoViewSave = $("#txtInfoViewSave").val(); if (fileType == "InfoView" && InfoViewSave == "") { alert("详细视图保存文件名不能为空1"); return false; }
    }
    if (fileType == "EditView" || (fileType == "" && $("#chkEditView").is(':checked'))) {
        Info = $("#txtInfo").val();
        if (Info == "") { alert("数据项不能为空"); return false; }
        EditViewTemp = $("#txtEditViewTemp").val(); if (fileType == "EditView" && EditViewTemp == "") { alert("编辑视图模板不能为空2"); return false; }
        EditViewSave = $("#txtEditViewSave").val(); if (fileType == "EditView" && EditViewSave == "") { alert("编辑视图保存文件名不能为空2"); return false; }
    }

    var modelSpace = $("#txtModelSpace").val();
    var data = "appPath=" + appPath + "&configFile=" + configFile + "&ModelName=" + ModelName + "&fileType=" + fileType + "&ModelTemp=" + ModelTemp + "&modelSpace=" + modelSpace + "&BLLTemp=" + BLLTemp + "&ControllerTemp=" + ControllerTemp;
    data += "&ListViewTemp=" + ListViewTemp + "&Grid=" + escape(Grid) + "&InfoTemp=" + $("#txtInfoTemp").val() + "&ListViewSave=" + ListViewSave;
    data += "&EditViewTemp=" + EditViewTemp + "&EditViewSave=" + EditViewSave;
    data += "&InfoViewTemp=" + InfoViewTemp + "&InfoViewSave=" + InfoViewSave + "&Info=" + escape(Info);
    //alert(data);

    ap.go("doCreateFile", data, "json");

    return true;
}

function doCreateInfoHtml() {
    var Info = $("#txtInfo").val();
    if (Info == "") { alert("数据项不能为空"); return false; }

    var EditViewTemp = "", InfoViewTemp = "", InfoTemp = "";
    if ($('#chkEditView').is(':checked')) EditViewTemp = $("#txtEditViewTemp").val();
    if ($('#chkInfoView').is(':checked')) InfoViewTemp = $("#txtInfoViewTemp").val();
    InfoTemp = $("#txtInfoTemp").val();
    if (EditViewTemp == "" && InfoViewTemp == "" && InfoTemp == "") { alert("视图模板、临时模板不能同时为空"); return false; }

    var data = "EditViewTemp=" + EditViewTemp + "&InfoViewTemp=" + InfoViewTemp + "&InfoTemp=" + escape(InfoTemp) + "&Info=" + escape(Info);
    //alert(data);
    ap.success = CreateInfoHtmlEnd;
    ap.go("doCreateInfoHtml", data, "text");
}

function CreateInfoHtmlEnd(resData) {
    $("#txtInfoHtml").val(resData);
}

